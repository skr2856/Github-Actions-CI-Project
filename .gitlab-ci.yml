stages:
  - clone
  - compile
  - test
  - sonar
  - build
  - push
  - deploy

# --------- Clone GitHub Repo ---------
clone_repo:
  stage: clone
  image: alpine:latest
  tags:
    - docker-runner
  script:
    - apk add --no-cache git
    - git clone https://github.com/skr2856/Github-Actions-CI-Project.git
  artifacts:
    paths:
      - project

# --------- Compile Stage ---------
compile:
  stage: compile
  image: maven:3.9.9-eclipse-temurin-17
  tags:
    - docker-runner
  script:
    - cd project
    - echo "ğŸš€ Compiling project"
    - mvn -B compile
  dependencies:
    - clone_repo

# --------- Test Stage ---------
test:
  stage: test
  image: maven:3.9.9-eclipse-temurin-17
  tags:
    - docker-runner
  script:
    - cd project
    - echo "ğŸ§ª Running tests"
    - mvn test
  dependencies:
    - clone_repo

# --------- SonarQube Stage ---------
sonar:
  stage: sonar
  image: maven:3.9.9-eclipse-temurin-17
  tags:
    - docker-runner
  script:
    - cd project
    - echo "ğŸ” Running SonarQube analysis"
    - mvn sonar:sonar -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN
  dependencies:
    - clone_repo

# --------- Docker Build Stage ---------
docker_build:
  stage: build
  image: docker:20.10.24
  services:
    - docker:dind
  tags:
    - docker-runner
  script:
    - echo "ğŸ³ Building Docker image"
    - docker build -t my-image:latest project/
  dependencies:
    - clone_repo

# --------- Docker Push Stage ---------
docker_push:
  stage: push
  image: docker:20.10.24
  services:
    - docker:dind
  tags:
    - docker-runner
  script:
    - echo "ğŸ“¦ Pushing Docker image"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker push my-image:latest
  dependencies:
    - docker_build

# --------- Deploy Stage ---------
deploy:
  stage: deploy
  image: alpine:latest
  tags:
    - docker-runner
  script:
    - echo "ğŸš€ Deploying application"
    # Add your deploy commands here
  dependencies:
    - docker_push
